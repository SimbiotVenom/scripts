autoinstall:
  version: 1
  # Basic system configuration
  locale: en_US.UTF-8
  keyboard:
    layout: us
  
  # Installer updates
  refresh-installer:
    update: true
    channel: stable/ubuntu-$REL
  
  # Explicit storage configuration
  storage:
    config:
      - type: disk
        id: first-disk
        match:
          size: largest  # Targets largest available disk
        ptable: gpt
        wipe: superblock
        preserve: false
        grub_device: true
      - type: partition
        id: efi-partition
        device: first-disk
        size: 360M
        flag: boot
        fstype: fat32
        mount: /boot/efi
      - type: partition
        id: boot-partition
        device: first-disk
        size: 1G
        fstype: ext4
        mount: /boot
      - type: partition
        id: lvm-partition
        device: first-disk
        size: -1  # Use remaining space
      - type: lvm_volgroup
        id: vg0
        devices: [lvm-partition]
      - type: lvm_partition
        id: root-partition
        volgroup: vg0
        size: 100%
        fstype: ext4
        mount: /
  
  # Serial-based hostname
  early-commands:
    - |
      SERIAL=$(cat /sys/class/dmi/id/product_serial 2>/dev/null | tr -d '[:space:]')
      if [[ -z "$SERIAL" || "$SERIAL" == *"O.E.M."* ]]; then
        SERIAL="UNK-$(date +%s | md5sum | head -c 4)"
      fi
      echo "EP-$SERIAL" > /run/autoinstall-hostname
  
  identity:
    hostname: $(cat /run/autoinstall-hostname || echo "EP-FALLBACK")
    username: ""
    password: ""
  
  # Software selection
  packages:
    - ubuntu-minimal
  drivers:
    install: true  # Third-party drivers for graphics/WiFi
  codecs:
    install: true  # Additional media formats
  
  # APT configuration
  user-data:
    apt:
      primary:
        - arches: [amd64, i386]
          uri: http://archive.ubuntu.com/ubuntu  # Force main server
      security:
        - arches: [amd64, i386]
          uri: http://security.ubuntu.com/ubuntu
  
  # Edge and Intune installation
  late-commands:
    # Install Prerequisites
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y curl gpg

    # Install Microsoft GPG key
    - curtin in-target -- sh -c "curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/microsoft-edge.gpg"
    - curtin in-target -- sh -c "curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings//microsoft.gpg"
    
    # Add Microsoft repositories
    - curtin in-target -- sh -c "echo 'deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main' > /etc/apt/sources.list.d/microsoft-edge.list"
    - curtin in-target -- sh -c "echo 'deb [arch=amd64] https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $(lsb_release -cs) main' > /etc/apt/sources.list.d/microsoft-ubuntu-$(lsb_release -cs)-prod.list"
    
    # Install Edge and Intune
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y microsoft-edge-stable intune-portal